import {parseTailwindColor, getTailwindColor} from "/home/kdog3682/2024-javascript/csx/getColor.js"

import * as assets from "./assets.js"
import { lcm } from "/home/kdog3682/2023/math-utils.js"
/* prettier-ignore */ import {must, fooga, mconfig, unreachable, notify, storager, joiner, removeVeryStartingComments, ireplace, removeCommentsInPlace, editf, getLineTokens, IndexedStore, abstractError, bool, xassert, getSetLines, inMiddle, replaceLast, ensureExtension, multipleReplacer, getGradeLevel, constructEdit, getYear, Modulus, wrapClassMethods, proseReplacer, parseComments, parseFunctionDictComments, todo, dictAssertion, boundModularIncrement, construct, reduceToString2, pageTurner, assignCumulative, defaultMergeStrategy, dictSetter3, toArguments, reTemplate, parseFrontmatter, typeAssertion, defineGetter, assignAllowed, simpleRecursiveWalk, simpleArgument, exprTemplater, stringifyIfNotPrimitive, panic, stringerf, wrapFunction, regexTemplater, iso8601, strftime, walkChildEntries, getFiletype, matchf, isUrl, looksLikeFunction, toArgument2, notNull, CumulativeStorage2, simpleAssign, findAndMatch, infuseObjectArray, regexGetter, splitArg, isJavascriptComment, runTest, everyOther, splitByRange, get_regex, getImports, isJavascriptFile, isValidDateString, WriteObject, equalityf, group2, splitOnce2, dedent4, isLowerCase, looksLikeRegExpString, isRegExpString, getDependencies, camelSplit, toggle3, countf, isLiteralObject, bindMethodsAndState2, call, mget3, looks_like_object_function, create_functions_from_master, toStringArgumentPretty, codeChunks, smart_map, run_tests, hasStartingCallable, mapTemplate, aliaser, fixSelector, htmlTags, removePythonComments, simpleStringBreaker, colonConfig, operations, error, redColon, so2, group, parseSingleLineJson, Items, findDependencies, tryf, find4, localeString, cssComment, colonConfigf, trimArray, parseCallable, bringToLifeTextFix, localBringToLife, getCaller4, getErrorStack, forEach, getBindings, getExports, matchstr, filter4, allEqual, count, isNativeFunction, repeat, eat, getIndentAndText, StopWatch, stringDictSetter, getFunctionInfo, runRef, toLines, hasCallable, getProseWords, tally, paramify, codeSplit, debugConfig, logConfig, blueColon, toStringArgument3, stringCallable, simpleBinding, dashSplit4, appendBelow, appendAbove, removeLineComments, prependIfNecessary, smartDedent4, blueSandwich, walk4, findLineIndex, parseAB, applyTransform, kebabCase, getExcerpt, sortObject, buildFunction, maybeSort, parseFunction, isTypable, frontMatter, dictEntry, insertAfterIndex, State, bindMethods, cpop, tagRE, toggle2, createFunction2, assignIncrementedIndex, ufa, assignArray, regexFromComment, createParsersFromObject, imatch, globalConsoleDebug, bindMethodsAndState, isQuestion, oxfordComma, isUpperCase, getFunctionIdentifier, filter3, match, getMatch, alternatef, reCombine, assertion2, deepEqual, hasDollar, so, deepAssign, Tally, getFunctionNames, throwError, notEqual, tryString, prettyPrintCodeSnippet, prettyPrintErrorStack, iter, quotify, transformerf, assign, defineBinding, jspy, linebreak, stringCall2, reduce3, getClassParameters, assignOnTop2, isIdentifier, ndy, dashSplit3, runFunctionFromRef, equalf, alphabet, stateGetterFromSchema, mreplace, require, topLineComment, isChinese, replacef, ignoref, codeLibrary, splitLines, addArgumentQuotes, getBindings2, addCaret, mget2, getStartingConfig, incrementalEat, strlen, hr, setOnce, unescapeHtml, oxford, breakerf, runTests, map3, dateSplit, transformDict, walk3, toRegExp, tryAgainf, assertNotNull, getArgumentObject, isArgumentObject, typef, requireArg, keyAndValue, assignf, stateGetter3, objectFromArguments2, assignDefaults, transformValue, assign3, assignFresh3, evaluate3, scopedEvaluator, objectFromArguments, enforce, sub, filterObject, extractStartingJsonLikeConfig, unbrackify, newlineIndent2, deleteLine, both, normalizeIndent, getComment, secondComment, isStringRegExp, dashSplit2, clock, warning, errorStringify, alert, labelCase, bottomComment, stringCompose, getAnyIdentifier, chalkf, getNumbers, partitions, has, addUnit, toCallable, unquote, filter2, warn2, join2, caller2, assignOnce, longShort, shortLong, argPop, caller, assignOnTop, toggle, defineWindow, unescapeNewlines, escapeQuotes, unescapeQuotes, escapeNewlines, setAliases, announceCaller, removeStartingComments, smartBind, assignExisting, isObjectWithKey, eatStart, modularIncrementItem, getRegex, runFunction, isObjectLikeArray, itemGetter2, getAllKeys, prefixSlice, hasQuotes, assertion, diff, toggleState, initState, dunder, objectGetter, superTransform, popFilter, testRunner, assert2, insertAtDollar, popEmptyLine, getOptions, mergeSpecs, sortByKeys, map2, strictMessengerAssert, smartSplit, chalk4, typeLog, getFunctionName, Clock, search3, MyError, fuzzyMatch3, debugDisplay, getCaller3, messengerAssert, camelSlice, setPrototype, assignAliases, display, modifyNumber, toDict, setPush, modularIncrementIndex, longstamp, popIndex, toggleOnOff, locWrap, walk2, typeMatch, prettyStringify, getIdentifiers, CustomError, argMatch, brackify2, smartestDedent, modularIncrementNumber, AbstractMethodError, allUnique, Trie, boundarySplit, numberBoundarySplit, nodeLog, getFirst, defineProperty, supermix, partial, timeLog, timestamp, raise, getIdentifier, conditionalPrefix, conditionalSuffix, QueryList, fuzzyMatch2, buildDict, getTextAndCommand, sprawlFactory, getParameters2, pushf, intersection, union, blue, green, getLastSpaces, smartDedent3, red, sort, debounce, checkValue, getCodeChunks, logf, boundary, myError, conditional, isStringFunction, toSpaces, objectf, searchAll, difference, singleQuote, itemGetter, slice2, mergeObjects, once, dashSplit, nchalk, coerceToObject, ArrayState, exporter2, indent2, iterator, removeAllComments, countParams, cumulativeSchemaAssign, argKwargSplit, argParse, removeInlineComments, getFrontMatter, hasHtmlSuffix, lazyArray, isThisFunction, escapeHTML, getKwargs2, search2, toStringArgument, createFuzzyMatch, edit2, splice, zip, merge2, argArgsKwargs, fill2, chalk, vueWrap, splitArray, splitArray2, warn, makeRunner2, searchf2, smartDedent2, dedent2, toArray2, stateGetter2, sortByIndex, IndexedCache, argo, curry2, doUntil2, evaluate2, findall2, findIndex2, findItem2, getCaller2, getErrorStack2, isJson, indexGetter2, insert2, pop2, parseError2, remove2, reduce2, testf2, type2, unshift2, waterfall2, xsplit2, Cache, cumulativeAssign, replaceBefore, topComment, isAsyncFunction, mapSort, getFileURI, getQuotes, isClassObject, isInitialized, getFallback, bindingRE, addObjectOrObjectProperty, forDoubles, isCss, log, iterate, backAndForth, round, iteratorWrapper, toJSON, isFromMap, toString, empty, conditionalString, getConfigArg, hasKey, errorWrap, successWrap, check, toPoints, bind, mixinAliases, isPercentage, isBasicType, reducerStrategy, gather, entries, stateGetter, methodCase, vueCase, push2, smarterIndent, lineSplit, Store, isSingleLetter, prepareText, isSymbol, getShortest, slice, KeyError, deepCopy, argsKwargs, isError, isColor, list, objectEditor, matchall, makeFastRunner, announce, hasLetter, filter, reduce, stringCall, capitalizeName, stop, proseCase, lineDitto, mixinSetters, modularIncrement, distinct, definedSort, groupBy, reWrap2, fuzzyMatch, isPlural, Element, parseError, isPrimitiveArray, callableArgsKwargs, waterfall, defineVariable, info, flat2D, splitThePage, handleError, dedent, TypeAssertion, createFunction, pluralize, remove, Group, PageStorage, Storage, UniqueStorage, Watcher, arrayToDict, addProperty, addQuotes, argWrapFactory, assert, abrev, abf, addExtension, assignFresh, antif, atFirst, atSecond, backspace, bindObject, breaker, blockQuote, brackify, bringToLife, comment, countCaptureGroups, capitalizeTitle, classMixin, callableRE, camelToTitle, curry, createVariable, changeExtension, curryStart, curryEnd, capitalize, copy, camelCase, compose, char2n, camelToDash, deepMerge, datestamp, doublef, dictSetter, dictSetter2, dsearch, doUntil, dashCase, doubleQuote, dict, dictGetter, depluralize, dreplace, dictf, endsWithWord, exporter, edit, exists, evaluate, extend, find, flatMap, fill, fixUrl, functionGetter, findall, fixPath, flat, fparse, findIndex, firstLine, ftest, getKwargs, getFirstName, getBindingName, getParameters, getLastWord, getCodeWords, getCodeWords2, getIndent, getExtension, getLast, getLongest, getChunks, getCaller, getStackTrace, getConstructorName, getFirstWord, getWords, getSpaces, hasComma, hasSpaces, hasHtml, hasBracket, hasNewline, hasCaptureGroup, hasEquals, hasValue, hasCamelCase, hasNumber, hackReplace, insert, indexGetter, incrementf, isCallable, isQuote, isEven, isOdd, isLast, isHTML, isNode, interweave, inferLang, isString, isArray, isObject, isDefined, isFunction, isPrimitive, isNumber, isSet, isNestedArray, indent, isNull, isWord, isBoolean, isRegExp, identity, isObjectLiteral, isJsonParsable, isCapitalized, isNewLine, isObjectArray, isStringArray, isClassFunction, joinSpaces, join, keyArrayToObject, lowerCase, linebreakRE, len, lineGetter, lineCount, lastLine, logConsole, makeRunner, mixin, modularf, matchGetter, merge, mget, map, mergeOnTop, mergeToObject, mapFilter, noop, nestPush, no, newlineIndent, n2char, objectWalk, overlap, objectToString, opposite, pipe, parseTopAttrs, pascalCase, partition, parens, push, pop, parseJSON, rigidSort, removeQuotes, rep, removeComments, range, removeExtension, rescape, reverse, reWrap, reduceToString, repeatUntil, swapKey, sayhi, swap, splitMapJoin, splitCamel, smallify, search, stringify, shared, smartDedent, stringBreaker, sleep, split, snakeCase, stringArgument, sorted, splitOnce, searchf, secondLine, titleCase, textOrJson, toNumber, toArgument, toNestedArray, test, type, tail, transformObject, trim, testf, toArray, templater, totalOverlap, upperCase, unique, uncapitalize, unzip, wrap, walk, wrapf, xsplit, yes, zip2} from "/home/kdog3682/2023/utils.js"


export {
    handlers
}

const dirAliases = {
  "l": "left",
  "t": "top",
  "r": "right",
  "b": "bottom",
  "x": ["left", "right"],
  "y": ["top", "bottom"],
};



function gridTemplate(s) {
    const rows = split(s, /\|/)
    const table = rows.map((row) => {
        const chars = row.split('')
        const partitions = tally(chars)
        return {
            tally: partitions,
            length: chars.length,
        }
    })
    const lengths = table.map(len)
    const k = lcm(lengths)

    const computed = table.map(({tally, length}) => {
        const newRows = tally.map(([el, count]) => {
            const items = fill(el, count * k / length)
            return items
        })
        return newRows.flat()
    })

    const gridTemplateColumns = `repeat(${computed[0].length}, 1fr)`
    const gridTemplateRows = `repeat(${computed.length}, 1fr)`
    const gridTemplateAreas = computed.map((x) => doubleQuote(x.join(' '))).join(' ')

    return [
        ['display', 'grid'],
        ['grid-template-columns', gridTemplateColumns],
        ['grid-template-rows', gridTemplateRows],
        ['grid-template-areas', gridTemplateAreas],
    ]
}

function fontFamily(s) {
    return [['font-family', must(assets.fonts, s)]]
}

function box(n) {
    return [
        ["width", n],
        ["height", n]
    ]
}


function colorMatch(s) {
    const [key, index] = parseTailwindColor(s)
    const complementIndex = 900 - index
    return [
        ["background-color", getTailwindColor(key, index)],
        ["color", getTailwindColor(key, complementIndex)]
    ]
}


function stroke({ thickness = 1, paint = "black", dash = "solid" } = {}, dir, combined) {
    // console.log(dir)
    if (isArray(dir)) {
        const store = []
        for (const arg of dir) {
            store.push(...stroke(arguments[0], arg))
        }
        return store
    }
    const a = dir ? `border-${dir}-weight` : "border-weight"
    const b = dir ? `border-${dir}-color` : "border-color"
    const c = dir ? `border-${dir}-style` : "border-style"
    return [
        [a, thickness],
        [b, paint],
        [c, dash]
    ]
}

function helper(o, fn) {
            const directions = [ "top", "right", "left", "bottom"]
            const store = []
            for (const [k, v] of Object.entries(o)) {
                if (k == 'x') {
                    store.push(...fn(v, "left"))
                    store.push(...fn(v, "right"))
                }
                else if (k == 'y') {
                    store.push(...fn(v, "top"))
                    store.push(...fn(v, "bottom"))
                }
                else if (directions.includes(k)) {
                    store.push(...fn(v, k))
                }
            }
            if (empty(store)) {
                return fn(o)
            }
            return store
}
function padding(o, dir) {
    const a = dir ? `padding-${dir}` : "padding"
    return [[a, o]]
}

function _padding(n, dir) {
    return _marginOrPadding(n, dir, 'padding')
}

function _margin(n, dir) {
    return _marginOrPadding(n, dir, 'margin')
}
function _marginOrPadding(n, dir, key) {
    dir = dirAliases[dir] || dir
    if (isArray(dir)) {
        return dir.map((_dir) => _margin(n, _dir, key)).flat()
    }
    const a = dir ? `${key}-${dir}` : key
    return [[a, n]]
}

function margin(o, dir) {
    const a = dir ? `margin-${dir}` : "margin"
    return [[a, o]]
}

const ref = {
    padding: {
        String(s) { return [["padding", s]] },
        Object(o) { return helper(o, padding) }
    },

    _margin,
    _padding,

    margin: {
        String(s) { return [["margin", s]] },
        Object(o) { return helper(o, margin) }
    },

    _stroke: stroke,
    stroke: {
        String(s) { return [["border", s]] },
        Object(o) { return helper(o, stroke) }
    },
    shadow: {
        String: function (s) {
            return [['box-shadow', must(assets.shadow, s)]]
        },
    },
    grid: {
        Object(o) {
            const value = []
            value.push(['display', 'grid'])
            if (o.template) {
                value.push(...gridTemplate(o.template))
            }
            if (o.columns) { value.push(['grid-template-columns', o.columns]) }
            if (o.rows) { value.push(['grid-template-rows', o.rows]) }
            return value
        }
    },
    inset: {
        String: function (s) {
            return ["padding", s]
        },
        Object: function (o) {
            const mapper = ([k, v]) => {
                return [["padding-" + k, v]]
            }
        }
    },
    outset: {
        String: function (s) {
            return [["margin", s]]
        },
        Object: function (o) {
            const mapper = ([k, v]) => {
                return ["margin-" + k, v]
            }
            return Object.entries(o).map(mapper)
        }
    },
    sandwich: {
        Object(o) {
            const top = stroke(o, "top")
            const bottom = stroke(o, "bottom")
            return [...top, ...bottom]
        }
    },
    flex: {
        String(s) {
            const store = [ ['display', 'flex'] ]
            if (s == 'center') {
                store.push(['align-items', 'center'])
                store.push(['justify-content', 'center'])
            }
            else if (s == 'center') {
                store.push(['align-items', 'center'])
                store.push(['justify-content', 'center'])
            }
        },
        Object({dir = 'column'} = {}) {
            todo()
        }
    },

    box: {
        String: box
    },
    fontFamily,
    colorMatch,
    identity,
}

const create = (o) => {
    if (isFunction(o)) {
        return o
    }

    return function handler(value, key) {
        if (isNumber(value)) {
            value = value.toString()
        }
        const t = type(value)
        const fn = must(o, t)
        return fn(value, key)
    }
}
const handlers = dict(ref, create)
// console.log(handlers._margin(3, 'y'))
// console.log(handlers.box(5))
// console.log(handlers.padding({left: 3, right: 5, y: 10}))
// console.log(handlers.sandwich({paint: 'green'}))
// console.log(handlers.grid({template: 'ab', rows: '1fr 1fr'}))
// data[key] is messing up
